/***************************************************************************
 *
 *   Copyright (C) 2006 by Willem van Straten
 *   Licensed under the Academic Free License version 2.1
 *
 ***************************************************************************/

// #define _DEBUG 1

#include "Pulsar/Config.h"

// This file is generated by configure
#include "Management/psrchive_install.h"

#include "dirutil.h"

#include <iostream>
#include <stdlib.h>

using namespace std;

// global configuration
Pulsar::Config* Pulsar::Config::config = 0;

// global interface to configuration
Pulsar::Config::Interface* Pulsar::Config::interface = 0;

//! Default constructor
Pulsar::Config::Config ()
{
  databases_loaded = false;
}

//! Set the configuration filename
void Pulsar::Config::set_filename (const std::string& name)
{
  if (databases_loaded)
    throw Error (InvalidState, "Pulsar::Config::set_filename",
		 "databases have already been loaded");

  filename = name;
}


void Pulsar::Config::load () 
{
  if (databases_loaded)
    return;

  databases_loaded = true;

  if (! filename.empty()) try
  {
    DEBUG("Pulsar::Config::load filename=" << filename);
    Configuration::load( filename );
    return;
  }
  catch (Error& error)
  {
    throw error += "Pulsar::Config::load";
  }

  const char* psrchive_config = getenv ("PSRCHIVE_CONFIG");
  if (psrchive_config) try
  {
    string file = psrchive_config;
    if (file_is_directory (psrchive_config))
      file += "/.psrchive.cfg";

    DEBUG("Pulsar::Config::load $PSRCHIVE_CONFIG=" << file);
    Configuration::load( file );
  }
  catch (Error& error)
  {
    throw error += "Pulsar::Config::load";
  }
  
  const char* home = getenv ("HOME");
  string home_config;
  if (home) try
  {
    DEBUG("Pulsar::Config::load $HOME=" << home);
    home_config = string(home) + "/.psrchive.cfg";
    Configuration::load( home_config );
  }
  catch (Error& error)
  {
    // use of a configuration file is optional
    DEBUG("Pulsar::Config::load error loading " << home_config
	  << " "  << error.get_message());
  }

  const char* psrchive_config_last = getenv ("PSRCHIVE_CONFIG_LAST");
  if (psrchive_config_last) try
  {
    DEBUG("Pulsar::Config::load $PSRCHIVE_CONFIG_LAST=" << psrchive_config_last);
    Configuration::load( psrchive_config_last );
  }
  catch (Error& error)
  {
    // use of a configuration file is optional
    DEBUG("Pulsar::Config::load error loading " << psrchive_config_last << " "  << error.get_message());
  }
}



string Pulsar::Config::get_runtime ()
{
  return get_home() + "/share";
}

string Pulsar::Config::get_home ()
{
  char* psrchive = getenv ("PSRCHIVE");
  if (psrchive)
    return psrchive;

  return PSRCHIVE_INSTALL;
}

//! Return the configuration key/value pairs
Pulsar::Config* Pulsar::Config::get_configuration ()
{
  if (!config)
    config = new Config;

  return config;
}

//! Return the text interface to the configuration parameters
Pulsar::Config::Interface* Pulsar::Config::get_interface ()
{
  if (!interface)
    interface = new Interface;

  DEBUG("Pulsar::Config::get_interface return " << interface);

  return interface;
}

